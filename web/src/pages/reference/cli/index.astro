---
import Layout from '../../../components/Layout.astro';
import CodeBlock from '../../../components/CodeBlock.astro';

const base = import.meta.env.BASE_URL;
---

<Layout title="CLI Reference" description="Complete reference for azd exec command-line interface">
  <div class="page-container">
    <div class="page-header">
      <h1>CLI Reference</h1>
      <p class="page-intro">
        Complete command-line interface documentation for azd exec.
      </p>
    </div>

    <div class="content">
      <section class="section">
        <h2>Overview</h2>
        <p>
          The azd exec extension provides commands to execute scripts with Azure Developer CLI environment context.
        </p>
        <CodeBlock code="azd exec [command] [flags]" language="bash" />
      </section>

      <section class="section">
        <h2>Available Commands</h2>
        
        <div class="command-grid">
          <div class="command-card">
            <h3><code>exec &lt;script&gt;</code></h3>
            <p>Execute a script file or inline command with Azure context</p>
            <span class="command-example">azd exec ./script.sh</span>
          </div>

          <div class="command-card">
            <h3><code>version</code></h3>
            <p>Show azd exec version information</p>
            <span class="command-example">azd exec version</span>
          </div>
        </div>
      </section>

      <section class="section">
        <h2>Command Usage</h2>
        <CodeBlock code="azd exec [script-file-or-command] [flags] [-- script-args...]" language="bash" />
        
        <h3>Basic Examples</h3>
        <CodeBlock code={`# Execute a script file
azd exec ./deploy.sh

# Execute an inline command
azd exec 'echo "Environment: $AZURE_ENV_NAME"'

# Pass arguments to the script
azd exec ./build.sh -- --verbose --config release

# Specify shell explicitly
azd exec ./setup.ps1 --shell pwsh`} language="bash" />
      </section>

      <section class="section">
        <h2>Execution Flags</h2>
        <p>Control how scripts are executed:</p>
        
        <div class="flags-table">
          <table>
            <thead>
              <tr>
                <th>Flag</th>
                <th>Short</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><code>--shell</code></td>
                <td><code>-s</code></td>
                <td>Shell to use for execution: <code>bash</code>, <code>sh</code>, <code>zsh</code>, <code>pwsh</code>, <code>powershell</code>, <code>cmd</code>. Auto-detected from file extension or shebang if not specified.</td>
              </tr>
              <tr>
                <td><code>--interactive</code></td>
                <td><code>-i</code></td>
                <td>Run script in interactive mode, enabling user input and prompts.</td>
              </tr>
              <tr>
                <td><code>--stop-on-keyvault-error</code></td>
                <td></td>
                <td>Fail-fast: stop execution when any Key Vault reference fails to resolve.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <section class="section">
        <h2>Global Flags</h2>
        <p>These flags are inherited from azd and available for all commands:</p>
        
        <div class="flags-table">
          <table>
            <thead>
              <tr>
                <th>Flag</th>
                <th>Short</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><code>--output</code></td>
                <td><code>-o</code></td>
                <td>Output format: <code>default</code> or <code>json</code></td>
              </tr>
              <tr>
                <td><code>--debug</code></td>
                <td></td>
                <td>Enable debug mode with verbose logging</td>
              </tr>
              <tr>
                <td><code>--no-prompt</code></td>
                <td></td>
                <td>Disable prompts and use default values</td>
              </tr>
              <tr>
                <td><code>--cwd</code></td>
                <td><code>-C</code></td>
                <td>Sets the current working directory before execution</td>
              </tr>
              <tr>
                <td><code>--environment</code></td>
                <td><code>-e</code></td>
                <td>The name of the azd environment to use</td>
              </tr>
              <tr>
                <td><code>--help</code></td>
                <td><code>-h</code></td>
                <td>Show help for any command</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <section class="section">
        <h2>Azure Key Vault Integration</h2>
        <p>
          azd exec automatically resolves Azure Key Vault references in environment variables before running your script.
        </p>

        <h3>Supported Reference Formats</h3>
        <CodeBlock code={`# Format 1: SecretUri
@Microsoft.KeyVault(SecretUri=https://myvault.vault.azure.net/secrets/my-secret)
@Microsoft.KeyVault(SecretUri=https://myvault.vault.azure.net/secrets/my-secret/abc123)

# Format 2: VaultName and SecretName
@Microsoft.KeyVault(VaultName=myvault;SecretName=my-secret)
@Microsoft.KeyVault(VaultName=myvault;SecretName=my-secret;SecretVersion=abc123)

# Format 3: azd akvs URI (used internally by azd)
akvs://c3b3091e-400e-43a7-8ee5-e6e8cefdbebf/myvault/my-secret`} language="bash" />

        <h3>Authentication</h3>
        <p>Key Vault resolution uses the same Azure credentials as azd:</p>
        <ul>
          <li>Azure CLI (<code>az login</code>)</li>
          <li>Managed Identity (when running on Azure)</li>
          <li>Service Principal (environment variables)</li>
          <li>Visual Studio / VS Code authentication</li>
        </ul>

        <h3>Error Handling</h3>
        <p>If Key Vault resolution fails (secret not found, no access, etc.):</p>
        <ul>
          <li>Warning displayed to stderr (secret values are never printed)</li>
          <li>azd exec continues resolving other Key Vault references</li>
          <li>Successfully resolved secrets are substituted with their values</li>
          <li>Failed references remain unchanged</li>
        </ul>
        <p>To fail-fast (abort on the first Key Vault resolution error), use <code>--stop-on-keyvault-error</code>.</p>

        <h3>Example Workflow</h3>
        <CodeBlock code={`# 1. Store secret in Key Vault
az keyvault secret set --vault-name myvault --name db-password --value "Secret123!"

# 2. Set environment variable with Key Vault reference
azd env set DB_PASSWORD "@Microsoft.KeyVault(VaultName=myvault;SecretName=db-password)"

# 3. Use in script (automatically resolved)
azd exec 'echo "Password length: \${#DB_PASSWORD}"'`} language="bash" />
      </section>

      <section class="section">
        <h2>Examples</h2>
        
        <h3>Basic Execution</h3>
        <CodeBlock code={`# Execute a script file
azd exec ./deploy.sh

# Execute an inline command
azd exec 'echo "Environment: $AZURE_ENV_NAME"'

# Show version
azd exec version`} language="bash" />

        <h3>Shell Specification</h3>
        <CodeBlock code={`# Specify PowerShell
azd exec ./deploy.ps1 --shell pwsh

# Inline PowerShell command
azd exec 'Write-Host "Hello from $env:AZURE_ENV_NAME"' --shell pwsh

# Force bash for a .sh file
azd exec ./script.sh --shell bash`} language="bash" />

        <h3>Script Arguments</h3>
        <CodeBlock code={`# Pass arguments to the script
azd exec ./build.sh -- --verbose --config release

# Multiple arguments
azd exec ./deploy.sh -- production --force --no-cache`} language="bash" />

        <h3>Interactive Mode</h3>
        <CodeBlock code={`# Run script in interactive mode
azd exec ./interactive-setup.sh --interactive

# Interactive PowerShell script
azd exec ./wizard.ps1 --shell pwsh --interactive`} language="bash" />

        <h3>Multi-Environment Deployment</h3>
        <CodeBlock code={`# Deploy to development environment
azd exec ./deploy.sh --environment dev

# Deploy to production
azd exec ./deploy.sh --environment prod`} language="bash" />

        <h3>Debugging</h3>
        <CodeBlock code={`# Enable debug logging
azd exec ./deploy.sh --debug

# Check available environment variables
azd exec 'env | grep AZURE_' --debug`} language="bash" />

        <h3>Working with Key Vault</h3>
        <CodeBlock code={`# Set Key Vault reference
azd env set API_KEY "@Microsoft.KeyVault(VaultName=myvault;SecretName=api-key)"

# Script automatically gets the resolved secret value
azd exec ./deploy.sh

# Fail-fast on Key Vault errors
azd exec ./deploy.sh --stop-on-keyvault-error`} language="bash" />
      </section>

      <section class="section">
        <h2>Environment Variables</h2>
        <p>azd exec automatically provides these environment variables to your scripts:</p>
        
        <div class="env-table">
          <table>
            <thead>
              <tr>
                <th>Variable</th>
                <th>Description</th>
                <th>Example</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><code>AZURE_ENV_NAME</code></td>
                <td>Azure environment name from azd</td>
                <td>dev, staging, prod</td>
              </tr>
              <tr>
                <td><code>AZURE_SUBSCRIPTION_ID</code></td>
                <td>Active Azure subscription ID</td>
                <td>12345678-1234-...</td>
              </tr>
              <tr>
                <td><code>AZURE_LOCATION</code></td>
                <td>Azure region for resources</td>
                <td>eastus, westeurope</td>
              </tr>
              <tr>
                <td><code>AZURE_RESOURCE_GROUP</code></td>
                <td>Resource group name (if configured)</td>
                <td>rg-myapp-dev</td>
              </tr>
              <tr>
                <td><code>AZURE_TENANT_ID</code></td>
                <td>Azure AD tenant ID</td>
                <td>87654321-4321-...</td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <p>Additionally, all variables from your <code>.env</code> file are loaded.</p>
      </section>

      <section class="section">
        <h2>Exit Codes</h2>
        <p>azd exec uses these exit codes:</p>
        
        <div class="exit-codes">
          <table>
            <thead>
              <tr>
                <th>Code</th>
                <th>Meaning</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><code>0</code></td>
                <td>Success - script executed without errors</td>
              </tr>
              <tr>
                <td><code>1</code></td>
                <td>Script execution failed or script not found</td>
              </tr>
              <tr>
                <td><code>2</code></td>
                <td>Invalid arguments or configuration</td>
              </tr>
              <tr>
                <td>Non-zero</td>
                <td>Exit code from the executed script</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <section class="section">
        <h2>Related Documentation</h2>
        <div class="related-links">
          <a href={`${base}getting-started`}>Getting Started</a>
          <a href={`${base}examples`}>Examples</a>
          <a href={`${base}security`}>Security Guidelines</a>
        </div>
      </section>
    </div>
  </div>
</Layout>

<style>
  .page-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 3rem 1.5rem;
  }

  .page-header {
    margin-bottom: 3rem;
  }

  .page-header h1 {
    font-size: 2.5rem;
    font-weight: 700;
    margin: 0 0 1rem;
    color: var(--color-text-primary);
  }

  .page-intro {
    font-size: 1.25rem;
    color: var(--color-text-secondary);
    margin: 0;
  }

  .content {
    line-height: 1.7;
  }

  .section {
    margin-bottom: 3rem;
  }

  .section h2 {
    font-size: 1.75rem;
    font-weight: 600;
    margin: 0 0 1rem;
    color: var(--color-text-primary);
  }

  .section h3 {
    font-size: 1.25rem;
    font-weight: 600;
    margin: 2rem 0 1rem;
    color: var(--color-text-primary);
  }

  .section p {
    margin: 0 0 1rem;
    color: var(--color-text-secondary);
  }

  .command-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
    margin: 1.5rem 0;
  }

  .command-card {
    display: flex;
    flex-direction: column;
    border: 1px solid var(--color-border-default);
    border-radius: 0.5rem;
    padding: 1.5rem;
    text-decoration: none;
    background-color: var(--color-bg-primary);
    transition: border-color 0.2s;
    position: relative;
  }

  .command-card:not(.disabled):hover {
    border-color: var(--color-interactive-default);
  }

  .command-card.disabled {
    opacity: 0.6;
    cursor: default;
  }

  .command-card h3 {
    font-size: 1.25rem;
    margin: 0 0 0.5rem;
    color: var(--color-text-primary);
  }

  .command-card h3 code {
    color: var(--color-interactive-default);
  }

  .command-card p {
    margin: 0 0 1rem;
    font-size: 0.875rem;
    flex-grow: 1;
  }

  .command-example {
    font-family: var(--font-mono);
    font-size: 0.8125rem;
    color: var(--color-text-tertiary);
    background-color: var(--color-bg-secondary);
    padding: 0.5rem;
    border-radius: 0.25rem;
  }

  .badge {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background-color: var(--color-interactive-default);
    color: white;
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-weight: 600;
  }

  .flags-table, .env-table, .exit-codes {
    margin: 1.5rem 0;
    overflow-x: auto;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9375rem;
  }

  thead {
    background-color: var(--color-bg-secondary);
  }

  th {
    text-align: left;
    padding: 0.75rem 1rem;
    font-weight: 600;
    color: var(--color-text-primary);
    border-bottom: 2px solid var(--color-border-default);
  }

  td {
    padding: 0.75rem 1rem;
    color: var(--color-text-secondary);
    border-bottom: 1px solid var(--color-border-default);
  }

  td code {
    background-color: var(--color-bg-secondary);
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    font-size: 0.875rem;
  }

  .related-links {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .related-links a {
    color: var(--color-interactive-default);
    font-weight: 600;
    text-decoration: none;
  }

  .related-links a:hover {
    text-decoration: underline;
  }
</style>
